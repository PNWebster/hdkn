<?xml version="1.0" encoding="utf-8" ?>

<?if $(var.Platform) = x64?>
    <?define UpgradeCode = "D0B78BE3-D432-434A-9FB6-2E97A2EBDAD2"?>
    <?define InstallDir = "[ProgramFiles64Folder]"?>
    <?define IsWin64 = "yes"?>
<?else?>
    <?define UpgradeCode = "B1E9D22F-AA98-412E-8CC8-1097A8BC3193"?>
    <?define InstallDir = "[ProgramFilesFolder]"?>
    <?define IsWin64 = "no"?>
<?endif?>

<Wix
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://schemas.microsoft.com/wix/2006/wi"
    xmlns:bal="http://schemas.microsoft.com/wix/BalExtension"
    xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

    <Bundle
        Name="$(var.Name)"
        Manufacturer="Viktor Elofsson - vktr.se"
        UpgradeCode="$(var.UpgradeCode)"
        Version="$(var.Version)">

        <WixVariable 
            Id="WixMbaPrereqPackageId" 
            Value="Netfx4Full" />
        <WixVariable 
            Id="WixMbaPrereqLicenseUrl" 
            Value="NetfxLicense.rtf" />

        <BootstrapperApplicationRef Id="ManagedBootstrapperApplicationHost">
            <Payload SourceFile="$(var.InstallerResources)/Hadouken.Installer.dll" />
            <Payload
                SourceFile="$(var.InstallerResources)/Hadouken.Installer.dll.config"
                Name="BootstrapperCore.config" />
            <Payload SourceFile="$(var.InstallerResources)/NetfxLicense.rtf" />
        </BootstrapperApplicationRef>

        <Variable Name='InstallFolder' Type='string' Value='$(var.InstallDir)Hadouken' />
        <util:RegistrySearch Id="PreviousInstallFolderSearch" Root='HKLM' Key='SOFTWARE\Hadouken\' Value='InstallFolder' Variable='PreviousInstallFolder' />
        <util:DirectorySearch Path='[PreviousInstallFolder]' Variable='InstallFolder' After='PreviousInstallFolderSearch' Condition='PreviousInstallFolder' />

        <Chain>
            <MsiPackage
                Id="Hadouken"
                Compressed="yes"
                SourceFile="$(var.MsiPackage)"
                Vital="yes">

                <MsiProperty Name="INSTALLDIR" Value="[InstallFolder]" />
            </MsiPackage>
        </Chain>
    </Bundle>
</Wix>